<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Stock In - Recents</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
    <nav class="nav">
        <a href="/research.html">Research</a> |
        <a href="/recents.html">Recents</a> |
        <a href="/favourites.html">Favourites</a>

    </nav>
    <main class="container">
        <h1>Recents</h1>
        <div id="recentsList">Loading...</div>
    </main>
    <!-- <script>
        async function loadRecents() {
            const res = await fetch('/api/recents');
            const j = await res.json();
            const root = document.getElementById('recentsList');
            root.innerHTML = '';
            if (!j.recents || j.recents.length === 0) {
                root.innerText = 'No recent searches yet.';
                return;
            }
            j.recents.forEach(r => {
                const div = document.createElement('div');
                div.className = 'recent';
                div.innerHTML = `<strong>${r.company}</strong> â€” <em>${r.tab}</em><div class="prompt">Q: ${r.prompt}</div><details><summary>Answer</summary><div class="response">${r.response}</div><div class="meta">At: ${r.created_at}</div></details>`;
                root.appendChild(div);
            });
        }
        loadRecents();
    </script> -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    async function loadRecents() {
        const res = await fetch('/api/recents');
        const j = await res.json();
        const root = document.getElementById('recentsList');
        if (!root) return console.error("recentsList element not found");

        root.innerHTML = '';

        if (!j.recents || j.recents.length === 0) {
            root.innerText = 'No recent searches yet.';
            return;
        }

        j.recents.forEach(r => {
            const div = document.createElement('div');
            div.className = 'recent';

            const star = document.createElement('span');
            star.innerHTML = 'â­';
            star.style.cursor = 'pointer';
            star.style.marginRight = '8px';
            star.title = 'Add to favourites';
            star.onclick = async () => {
                try {
                    const favRes = await fetch('/api/favourites');
                    const favs = await favRes.json();
                    const exists = favs.favourites.some(f => f.company_name.toLowerCase() === r.company.toLowerCase());
                    if (exists) return alert(`${r.company} is already in favourites.`);

                    const postRes = await fetch('/api/favourites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            company_id: 0,
                            company_name: r.company,
                            isFavourite: true
                        })
                    });

                    postRes.ok ? alert(`${r.company} added to favourites!`) : alert(`Failed to add ${r.company}.`);
                } catch {
                    alert('Error adding to favourites.');
                }
            };

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'ðŸ—‘ï¸ Remove';
            removeBtn.style.marginLeft = '10px';
            removeBtn.onclick = async () => {
                const confirmDelete = confirm(`Remove recent entry for "${r.company}"?`);
                if (!confirmDelete) return;

                const res = await fetch('/api/remove_recent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: r.id })
                });
                if (res.ok) {
                    alert(`Removed "${r.company}" from recents.`);
                    loadRecents();
                } else {
                    alert('Failed to remove.');
                }
            };

            div.innerHTML = `
                <strong>${r.company}</strong> â€” <em>${r.tab}</em>
                <div class="prompt">Q: ${r.prompt}</div>
                <details>
                    <summary>Answer</summary>
                    <div class="response">${r.response}</div>
                    <div class="meta">At: ${r.created_at}</div>
                </details>
            `;

            div.prepend(star);
            div.appendChild(removeBtn);
            root.appendChild(div);
        });
    }

    loadRecents();
});
</script>


</body>

</html>