<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Stock In - Recents</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="nav">
        <a href="/research.html">Research</a>
        <a href="/recents.html" class="active">Recents</a>
        <a href="/favourites.html">Favourites</a>
        <a href="/news.html">News</a>
    </nav>

    <main class="container">
        <h1>Recent Activity</h1>
        <div id="recentsList">Loading...</div>
    </main>

<script src="/static/app.js"></script> 
<script>
document.addEventListener('DOMContentLoaded', () => {
    async function loadRecents() {
        // CHANGED: Use apiFetch for authenticated requests
        const res = await apiFetch('/api/recents'); 
        
        if (res.status === 401) {
            document.getElementById('recentsList').innerText = 'Access denied. Redirecting...';
            // apiFetch handles the redirect, so we stop here.
            return;
        }

        const j = await res.json();
        const root = document.getElementById('recentsList');
        if (!root) return console.error("recentsList element not found");

        if (!j.recents || j.recents.length === 0) {
            root.innerText = 'No recent searches yet.';
            return;
        }

        root.innerHTML = `
            <div class="recent-container">
                ${j.recents.map(r => `
                    <div class="recent-card">
                        <h3>${r.company} ‚Äî <small><em>${r.tab}</em></small></h3>
                        <p>Q: ${r.prompt}</p>
                        <details>
                            <summary>Answer</summary>
                            <div class="response">${r.response}</div>
                            <div class="meta">At: ${r.created_at}</div>
                        </details>
                        <div class="recent-buttons">
                            <button class="fav-btn" data-company="${r.company}">‚≠ê Favourite</button>
                            <button class="remove-btn" data-id="${r.id}">üóë Remove</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // Attach button logic after rendering
        document.querySelectorAll('.fav-btn').forEach(btn => {
            btn.onclick = async () => {
                const company = btn.dataset.company;
                try {
                    // CHANGED: Use apiFetch for fetching favorites list
                    const favRes = await apiFetch('/api/favourites'); 
                    
                    if (favRes.status === 401) return; // Handled by apiFetch
                    
                    const favs = await favRes.json();
                    const exists = favs.favourites.some(f => f.company_name.toLowerCase() === company.toLowerCase());
                    if (exists) return alert(`${company} is already in favourites.`);

                    // CHANGED: Use apiFetch for adding favorite
                    const postRes = await apiFetch('/api/favourites', {
                        method: 'POST',
                        body: JSON.stringify({ company_id: 0, company_name: company, isFavourite: true })
                    });
                    
                    if (postRes.status === 401) return; // Handled by apiFetch
                    
                    postRes.ok ? alert(`${company} added to favourites!`) : alert(`Failed to add ${company}.`);
                } catch {
                    alert('Error adding to favourites.');
                }
            };
        });

        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.id;
                const confirmDelete = confirm(`Remove recent entry?`);
                if (!confirmDelete) return;

                // CHANGED: Use apiFetch for removing recent
                const res = await apiFetch('/api/remove_recent', {
                    method: 'POST',
                    body: JSON.stringify({ id })
                });
                
                if (res.status === 401) return; // Handled by apiFetch
                
                if (res.ok) {
                    alert(`Removed recent entry.`);
                    loadRecents();
                } else {
                    alert('Failed to remove.');
                }
            };
        });
    }

    // Call loadRecents only if the user is authenticated (app.js handles the initial check/redirect)
    loadRecents();
});
</script>
</body>
</html>